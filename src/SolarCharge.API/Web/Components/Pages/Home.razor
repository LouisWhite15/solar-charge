@page "/"
@rendermode InteractiveServer
@using SolarCharge.API.Application.Features.TeslaAuth.Commands
@using SolarCharge.API.Application.Features.TeslaAuth.Services
@using Wolverine

<PageTitle>SolarCharge</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4 text-center">Login to Tesla</h1>

            <p class="text-center">
                Use the fields below to login to Tesla to enable integration with your Tesla vehicle.
            </p>

            @if (!string.IsNullOrEmpty(_teslaLogonUrl))
            {
                <div class="text-center mb-3">
                    <a href="@_teslaLogonUrl" target="_blank" class="btn btn-primary">Tesla Logon URL</a>
                </div>

                <p class="text-center">
                    Follow the link above and log in using Tesla's authentication.<br />
                    When you get to a "Page not Found" page, copy the URL from your browser and paste it into the form below.
                </p>
            }

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="post" @onsubmit="SubmitUrlWithCodeAsync" @onsubmit:preventDefault="true" @formname="tesla-auth-url">
                        <AntiforgeryToken />
                        <div class="mb-3">
                            <label class="form-label">URL:</label>
                            <InputText @bind-Value="@UrlWithCode" class="form-control"/>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Submit URL with Code</button>
                    </form>
                </div>
            </div>
            
            @if (_authenticationSuccessful is true)
            {
                <div class="text-center mt-3">
                    <p class="text-success fw-bold">Tesla authentication was successful!</p>
                </div>
            }
            @if (_authenticationSuccessful is false)
            {
                <div class="text-center mt-3">
                    <p class="text-danger fw-bold">Tesla authentication failed. Please check the URL and try again.</p>
                </div>
            }

            <p class="text-center text-muted fw-semibold">
                🚧 Manual token entry — <span class="text-warning">coming soon</span>.
            </p>

            <div class="card shadow-sm opacity-50">
                <div class="card-body">
                    <form method="post" @onsubmit="SubmitProvidedTokens" @formname="tesla-provided-auth-token">
                        <AntiforgeryToken />
                        <div class="mb-3">
                            <label class="form-label">Access Token:</label>
                            <InputText @bind-Value="@AccessToken" class="form-control" disabled />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Refresh Token:</label>
                            <InputText @bind-Value="@RefreshToken" class="form-control" disabled />
                        </div>
                        <button type="submit" class="btn btn-success w-100" disabled>Submit Tokens</button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

@code {
    [Inject]
    private IMessageBus MessageBus { get; set; }
    
    [Inject]
    private ITeslaAuthenticationService TeslaAuthenticationService { get; set; }

    private Dictionary<string, string> AuthenticationParameters { get; set; }
    private bool? _authenticationSuccessful;

    private string? _teslaLogonUrl = null;
    
    [SupplyParameterFromForm(FormName = "tesla-auth-url")]
    private string? UrlWithCode { get; set; }
    
    [SupplyParameterFromForm(FormName = "tesla-provided-auth-token")]
    private string? AccessToken { get; set; }
    
    [SupplyParameterFromForm(FormName = "tesla-provided-auth-token")]
    private string? RefreshToken { get; set; }

    protected override Task OnInitializedAsync()
    {
        AuthenticationParameters = TeslaAuthenticationService.GetAuthenticationParameters();
        _teslaLogonUrl = GetTeslaLogonUrl(AuthenticationParameters);

        return Task.CompletedTask;
    }

    private async Task SubmitUrlWithCodeAsync()
    {
        if (UrlWithCode is null)
            return;

        var authenticateCommand = new AuthenticateTeslaCommand(UrlWithCode, AuthenticationParameters);
        _authenticationSuccessful = await MessageBus.InvokeAsync<bool>(authenticateCommand);
    }

    private static void SubmitProvidedTokens()
    {
        // Coming soon
    }

    private static string GetTeslaLogonUrl(Dictionary<string, string> authenticationParameters)
    {
        var queryParameters = new Dictionary<string, string>
        {
            {"client_id", authenticationParameters["client_id"]},
            {"code_challenge", authenticationParameters["code_challenge"]},
            {"code_challenge_method", authenticationParameters["code_challenge_method"]},
            {"redirect_uri", authenticationParameters["redirect_uri"]},
            {"response_type", authenticationParameters["response_type"]},
            {"scope", authenticationParameters["scope"]},
            {"state", authenticationParameters["state"]}
        };

        var queryString = BuildQueryString(queryParameters);
        return $"https://auth.tesla.com/oauth2/v3/authorize?{queryString}";
    }

    private static string BuildQueryString(Dictionary<string, string> parameters)
    {
        var list = new List<string>();
        foreach (var kvp in parameters)
        {
            var encodedKey = Uri.EscapeDataString(kvp.Key);
            var encodedValue = Uri.EscapeDataString(kvp.Value);
            list.Add($"{encodedKey}={encodedValue}");
        }
        return string.Join("&", list);
    }
}